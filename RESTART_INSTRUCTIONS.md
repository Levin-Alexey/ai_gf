# üî• –°–†–û–ß–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤ –Ω–∞ VDS

## –ü—Ä–æ–±–ª–µ–º–∞
–í–æ—Ä–∫–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–æ **—Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º** (–±–µ–∑ –Ω–æ–≤—ã—Ö –ª–æ–≥–æ–≤ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π).
–ü–æ—ç—Ç–æ–º—É –¥–∞–∂–µ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –î–∂—É–¥–∏ –±–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –∫–∞–∫ –†–µ–π–Ω–∞.

## ‚úÖ –†–ï–®–ï–ù–ò–ï: –í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ VDS

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# 1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞ VDS
scp restart_services.sh root@your-vds-ip:/root/AI_GF/

# 2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ VDS
ssh root@your-vds-ip

# 3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /root/AI_GF

# 4. –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x restart_services.sh

# 5. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç
./restart_services.sh
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–æ–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ VDS
ssh root@your-vds-ip

# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /root/AI_GF  # –∏–ª–∏ –≥–¥–µ —É –≤–∞—Å –ø—Ä–æ–µ–∫—Ç

# –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥
git pull origin main

# –ù–∞–π–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
ps aux | grep "run_worker.py"
ps aux | grep "main.py"

# –£–±–µ–π—Ç–µ —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (–∑–∞–º–µ–Ω–∏—Ç–µ <PID> –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ PID)
kill -9 <PID_–≤–æ—Ä–∫–µ—Ä–∞>
kill -9 <PID_–±–æ—Ç–∞>

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∑–∞–Ω–æ–≤–æ
nohup python3 run_worker.py > logs/worker.log 2>&1 &
nohup python3 main.py > logs/bot.log 2>&1 &

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å
ps aux | grep -E "run_worker|main.py" | grep -v grep
```

## üîç –ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞: –ü—Ä–æ–≤–µ—Ä–∫–∞

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ (–¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å —ç–º–æ–¥–∑–∏):

```bash
# –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –≤–æ—Ä–∫–µ—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:
tail -f logs/worker.log

# –ò–ª–∏ –ª–æ–≥–∏ –±–æ—Ç–∞:
tail -f logs/bot.log
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å **–Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏** —Ç–∏–ø–∞:
```
üìã Current persona for user 525944420: persona_id=5, name=–î–∂—É–¥–∏
üì§ Sending to queue for user 525944420: persona_id=5
Persona loaded for telegram_id=525944420: persona_id=5, name=–î–∂—É–¥–∏, version=1, overrides_present=False
```

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ë–î (–∫–∞–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–ø–∏—Å–∞–Ω):

```bash
# –õ–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –≤–∞—à–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ (–µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ë–î):
cd E:\dev\python\AI_GF
python check_user_persona.py 525944420

# –ò–õ–ò –Ω–∞ VDS:
cd /root/AI_GF
python3 check_user_persona.py 525944420
```

–≠—Ç–æ –ø–æ–∫–∞–∂–µ—Ç:
- –ö–∞–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂ –∞–∫—Ç–∏–≤–µ–Ω (should be –î–∂—É–¥–∏, ID=5)
- –ò—Å—Ç–æ—Ä–∏—é –≤—ã–±–æ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
- –ü—Ä–µ–≤—å—é –ø—Ä–æ–º–ø—Ç–∞

### 3. –¢–µ—Å—Ç –≤ –±–æ—Ç–µ:

1. –û—á–∏—Å—Ç–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ (–∫–Ω–æ–ø–∫–∞ "üóë –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é")
2. –í—ã–±–µ—Ä–∏—Ç–µ –î–∂—É–¥–∏ –∑–∞–Ω–æ–≤–æ (—á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è)
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ: "–ü—Ä–∏–≤–µ—Ç, –∫–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?"
4. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –∏ –æ—Ç–≤–µ—Ç –±–æ—Ç–∞

## ‚ùì –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –≥–æ–≤–æ—Ä–∏—Ç "–†–µ–π–Ω–∞":

### –í–∞—Ä–∏–∞–Ω—Ç –ê: –ü—Ä–æ–±–ª–µ–º–∞ –≤ –ë–î

–í–æ–∑–º–æ–∂–Ω–æ –≤ –ë–î –¥–ª—è user_id=16 (telegram_id=525944420) —Å—Ç–æ–∏—Ç –Ω–µ –î–∂—É–¥–∏, –∞ –†–µ–π–Ω–∞.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SQL:**

```sql
-- 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å
SELECT 
    ups.id, ups.user_id, ups.persona_id, p.name, ups.is_current
FROM user_persona_settings ups
JOIN users u ON u.id = ups.user_id
JOIN personas p ON p.id = ups.persona_id
WHERE u.telegram_id = 525944420 AND ups.is_current = TRUE;

-- 2. –ù–∞–π–¥–∏—Ç–µ ID –î–∂—É–¥–∏
SELECT id, key, name FROM personas WHERE name LIKE '%–î–∂—É–¥–∏%';
-- –î–æ–ø—É—Å—Ç–∏–º ID = 5

-- 3. –°–±—Ä–æ—Å—å—Ç–µ –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
UPDATE user_persona_settings 
SET is_current = FALSE 
WHERE user_id = (SELECT id FROM users WHERE telegram_id = 525944420);

-- 4. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –î–∂—É–¥–∏ –∫–∞–∫ —Ç–µ–∫—É—â–µ–≥–æ
INSERT INTO user_persona_settings (user_id, persona_id, overrides, is_current, selected_at)
VALUES (
    (SELECT id FROM users WHERE telegram_id = 525944420),
    5,  -- ID –î–∂—É–¥–∏
    '{}',
    TRUE,
    NOW()
)
ON CONFLICT DO NOTHING;
```

### –í–∞—Ä–∏–∞–Ω—Ç –ë: –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç–∞—Ä–æ–µ –∏–º—è

–î–∞–∂–µ –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ –ë–î, LLM –º–æ–∂–µ—Ç "–ø–æ–º–Ω–∏—Ç—å" —Å—Ç–∞—Ä—ã–µ assistant-—Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Redis.

**–†–µ—à–µ–Ω–∏–µ:**
- –í –±–æ—Ç–µ –Ω–∞–∂–º–∏—Ç–µ "üóë –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é"
- –ò–õ–ò —á–µ—Ä–µ–∑ Redis CLI:
  ```bash
  redis-cli
  DEL chat_history:525944420
  ```

## üìä –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –≤—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:

```
2025-10-27 15:00:00 - handlers.chat - INFO - üìã Current persona for user 525944420: persona_id=5, name=–î–∂—É–¥–∏
2025-10-27 15:00:00 - handlers.chat - INFO - üì§ Sending to queue for user 525944420: persona_id=5
2025-10-27 15:00:01 - __main__ - INFO - Persona loaded for telegram_id=525944420: persona_id=5, name=–î–∂—É–¥–∏, version=1, overrides_present=False
```

–ò –±–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å: **"—Ç–≤–æ—è –î–∂—É–¥–∏"** (–∏–ª–∏ –∫–∞–∫ —Ç–∞–º –≤ –µ—ë –ø—Ä–æ–º–ø—Ç–µ), –∞ –Ω–µ "—Ç–≤–æ—è –†–µ–π–Ω–∞".

---

## üö® –í–ê–ñ–ù–û

**–ë–ï–ó –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê –í–û–†–ö–ï–†–ê –ò –ë–û–¢–ê –ù–ò–ß–ï–ì–û –ù–ï –ò–ó–ú–ï–ù–ò–¢–°–Ø!**

–°—Ç–∞—Ä—ã–π –∫–æ–¥ –≤ –ø–∞–º—è—Ç–∏ –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ git.
