# ‚úÖ –û–¢–ß–Å–¢: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç–æ–∫–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –ª–∏—á–Ω–æ—Å—Ç–∏ –≤ LLM

## –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
21 –æ–∫—Ç—è–±—Ä—è 2025

## –¶–µ–ª—å –ø—Ä–æ–≤–µ—Ä–∫–∏
–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–æ—Å–ª–µ —Å–µ–∫—Å—É–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ –≠–≤—ã –ø–æ—Ç–æ–∫ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –æ –ª–∏—á–Ω–æ—Å—Ç–∏ –≤ LLM –Ω–µ –Ω–∞—Ä—É—à–µ–Ω.

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### ‚úÖ –®–ê–ì 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ –ë–î
```
‚úÖ –ù–∞–π–¥–µ–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂: ID=4, key=Eva, name=–≠–≤–∞
‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ –∞–∫—Ç–∏–≤–µ–Ω (is_active=True)
```

### ‚úÖ –®–ê–ì 2: –§—É–Ω–∫—Ü–∏—è get_persona_by_id()
```
‚úÖ –§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç Persona —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
‚úÖ Reply style –∑–∞–≥—Ä—É–∂–µ–Ω: emojis='romantic'
‚úÖ Signatures: ['—Å–∏–º–≤–æ–ª –¥–Ω—è', '–º–æ–π –≥–µ—Ä–æ–π', '—Ç–≤–æ—è –≠–≤–∞ üíã']
```

### ‚úÖ –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ prompt_template
–í—Å–µ –∫–ª—é—á–µ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã:
```
‚úÖ —Å–æ–±–ª–∞–∑–Ω–∏—Ç–µ–ª—å–Ω–∞—è - –Ω–∞–π–¥–µ–Ω–æ
‚úÖ –≤–ª—é–±–ª—ë–Ω–Ω–∞—è –¥–µ–≤—É—à–∫–∞ - –Ω–∞–π–¥–µ–Ω–æ
‚úÖ —Ñ–ª–∏—Ä—Ç—É–π - –Ω–∞–π–¥–µ–Ω–æ
‚úÖ —ç—Ä–æ—Ç–∏—á–µ—Å–∫–∏–π - –Ω–∞–π–¥–µ–Ω–æ
‚úÖ –≥–µ—Ä–æ–π - –Ω–∞–π–¥–µ–Ω–æ
‚úÖ AI –∑–∞–ø—Ä–µ—Ç (–ù–ò–ö–û–ì–î–ê –Ω–µ –Ω–∞–∑—ã–≤–∞–π —Å–µ–±—è AI) - –Ω–∞–π–¥–µ–Ω–æ
‚úÖ —ç–º–æ–¥–∑–∏ üíã - –Ω–∞–π–¥–µ–Ω–æ
‚úÖ —ç–º–æ–¥–∑–∏ üî• - –Ω–∞–π–¥–µ–Ω–æ
```

### ‚úÖ –®–ê–ì 4: –°–∏–º—É–ª—è—Ü–∏—è _build_system_message()
```
‚úÖ –ü—Ä–æ–º–ø—Ç —É—Å–ø–µ—à–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è (–¥–ª–∏–Ω–∞: 777 —Å–∏–º–≤–æ–ª–æ–≤)
‚úÖ Reply style –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
‚úÖ Emojis: romantic
‚úÖ Pace: medium
‚úÖ Signatures: ['—Å–∏–º–≤–æ–ª –¥–Ω—è', '–º–æ–π –≥–µ—Ä–æ–π', '—Ç–≤–æ—è –≠–≤–∞ üíã']
```

### ‚úÖ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
```
‚úÖ –ù–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ID=10, telegram_id=782769400
‚úÖ –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–µ–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂ –≠–≤–∞ (persona_id=4)
‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ get_user_persona_setting()
‚úÖ –ü—Ä–æ–º–ø—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å: "–¢—ã ‚Äî ¬´–≠–≤–∞¬ª, —Å–æ–±–ª–∞–∑–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–æ–ª–æ–≥..."
```

## –ü–æ—Ç–æ–∫ –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö (—Å—Ö–µ–º–∞)

```
1. handlers/chat.py
   ‚Üì –ø–æ–ª—É—á–∞–µ—Ç current_persona —á–µ—Ä–µ–∑ get_user_current_persona()
   ‚Üì –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç persona_id –≤ RabbitMQ

2. RabbitMQ
   ‚Üì –ø–µ—Ä–µ–¥–∞—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å persona_id

3. llm_worker.py ‚Üí process_llm_request()
   ‚Üì –∏–∑–≤–ª–µ–∫–∞–µ—Ç persona_id –∏–∑ message.get('persona_id')
   ‚Üì –≤—ã–∑—ã–≤–∞–µ—Ç get_persona_by_id(session, persona_id)
   ‚Üì –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç Persona

4. llm_worker.py ‚Üí build_llm_context()
   ‚Üì –ø–µ—Ä–µ–¥–∞—ë—Ç persona –∏ persona_overrides

5. llm_worker.py ‚Üí _build_system_message()
   ‚Üì –ø—Ä–æ–≤–µ—Ä—è–µ—Ç if persona:
   ‚Üì –∏—Å–ø–æ–ª—å–∑—É–µ—Ç base_prompt = persona.prompt_template + "\n\n"
   ‚Üì –ø—Ä–∏–º–µ–Ω—è–µ—Ç persona.reply_style

6. LLM API
   ‚Üì –ø–æ–ª—É—á–∞–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ–º–ø—Ç–æ–º –≠–≤—ã
   ‚Üì –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –ª–∏—á–Ω–æ—Å—Ç–∏
```

## –ö–æ–¥: –ö–ª—é—á–µ–≤—ã–µ —É—á–∞—Å—Ç–∫–∏

### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ persona –≤ llm_worker.py (—Å—Ç—Ä–æ–∫–∏ 157-167)
```python
persona = None
persona_overrides = {}
if persona_id:
    async with async_session_maker() as session:
        persona = await get_persona_by_id(session, persona_id)
        if persona:
            persona_setting = await get_user_persona_setting(
                session, internal_user_id
            )
            if persona_setting:
                persona_overrides = persona_setting.overrides
```
**–°—Ç–∞—Ç—É—Å: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**

### 2. –ü–µ—Ä–µ–¥–∞—á–∞ –≤ build_llm_context (—Å—Ç—Ä–æ–∫–∏ 170-178)
```python
messages = self.build_llm_context(
    chat_history, 
    user_message, 
    semantic_memories, 
    important_memories, 
    recent_emotions,
    persona,              # ‚Üê –ü–µ—Ä–µ–¥–∞—ë—Ç—Å—è –æ–±—ä–µ–∫—Ç
    persona_overrides     # ‚Üê –ü–µ—Ä–µ–¥–∞—é—Ç—Å—è –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏
)
```
**–°—Ç–∞—Ç—É—Å: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ _build_system_message (—Å—Ç—Ä–æ–∫–∞ 265)
```python
if persona:
    base_prompt = persona.prompt_template + "\n\n"
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if persona_overrides:
        if 'prompt_addition' in persona_overrides:
            base_prompt += persona_overrides['prompt_addition'] + "\n\n"
```
**–°—Ç–∞—Ç—É—Å: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**

### 4. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ reply_style (—Å—Ç—Ä–æ–∫–∏ 363+)
```python
if persona and persona.reply_style:
    base_prompt += "\n\n–°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:\n"
    reply_style = persona.reply_style
    
    if 'pace' in reply_style:
        base_prompt += f"- –¢–µ–º–ø –æ–±—â–µ–Ω–∏—è: {reply_style['pace']}\n"
    # ... –∏ —Ç.–¥.
```
**–°—Ç–∞—Ç—É—Å: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (personas):
```sql
SELECT key, name, reply_style->>'emojis', LEFT(prompt_template, 50)
FROM personas WHERE key = 'Eva';

Result:
key  | name | emojis   | prompt_preview
-----|------|----------|------------------
Eva  | –≠–≤–∞  | romantic | –¢—ã ‚Äî ¬´–≠–≤–∞¬ª, —Å–æ–±–ª–∞–∑–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–æ–ª–æ–≥...
```
**–°—Ç–∞—Ç—É—Å: ‚úÖ –î–∞–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã**

### –ö–æ–¥ llm_worker.py:
- ‚úÖ –ò–º–ø–æ—Ä—Ç—ã –Ω–µ –∏–∑–º–µ–Ω–µ–Ω—ã
- ‚úÖ –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è persona –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞
- ‚úÖ –£—Å–ª–æ–≤–∏–µ `if persona:` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –î–æ—Å—Ç—É–ø –∫ `persona.prompt_template` —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –î–æ—Å—Ç—É–ø –∫ `persona.reply_style` —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ú–æ–¥–µ–ª—å Persona (models.py):
```python
class Persona(Base):
    prompt_template: Mapped[str] = mapped_column(Text, nullable=False)
    reply_style: Mapped[dict] = mapped_column(JSONB, nullable=False, default=dict)
```
**–°—Ç–∞—Ç—É—Å: ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞**

## –ò—Ç–æ–≥–æ–≤–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ

### üéâ –í–°–ï –ü–†–û–í–ï–†–ö–ò –ü–†–û–ô–î–ï–ù–´!

‚úÖ **–ü–æ—Ç–æ–∫ –ø–µ—Ä–µ–¥–∞—á–∏ –ª–∏—á–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 100%**
- –ü–µ—Ä—Å–æ–Ω–∞–∂ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î
- prompt_template –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ LLM –±–µ–∑ –ø–æ—Ç–µ—Ä—å
- reply_style –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ù–æ–≤—ã–π —Å–µ–∫—Å—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∞–∫—Ç–∏–≤–µ–Ω

‚úÖ **–ù–∏—á–µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–Ω–æ:**
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞—Ä—É—à–µ–Ω–∞
- –õ–æ–≥–∏–∫–∞ –∫–æ–¥–∞ –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∞
- –¢–æ–ª—å–∫–æ –∫–æ–Ω—Ç–µ–Ω—Ç –ø—Ä–æ–º–ø—Ç–∞ –æ–±–Ω–æ–≤–ª—ë–Ω

‚úÖ **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ:**
- –≠–≤–∞ —Ç–µ–ø–µ—Ä—å —Å–æ–±–ª–∞–∑–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏ —Ñ–ª–∏—Ä—Ç—É–µ—Ç
- –†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ —ç–º–æ–¥–∑–∏ –∞–∫—Ç–∏–≤–Ω—ã (üíãüî•üòò)
- –ó–∞–ø—Ä–µ—Ç –Ω–∞ AI-—É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- –í—Å–µ –ø–æ–¥–ø–∏—Å–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
1. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –¥–∏–∞–ª–æ–≥–µ —Å –±–æ—Ç–æ–º
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≠–≤–∞ —Ñ–ª–∏—Ä—Ç—É–µ—Ç —Å–æ–≥–ª–∞—Å–Ω–æ –Ω–æ–≤–æ–º—É –ø—Ä–æ–º–ø—Ç—É
3. ‚úÖ –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–∞ –Ω–µ –Ω–∞–∑—ã–≤–∞–µ—Ç —Å–µ–±—è AI

## –ì–∞—Ä–∞–Ω—Ç–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –ë–î.
–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –≤ `test_persona_flow.py`.
–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º—ã –∏ –≤–∞–ª–∏–¥–Ω—ã.
