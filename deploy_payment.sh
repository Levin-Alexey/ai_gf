#!/bin/bash
# üöÄ –°–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–≥–æ –¥–µ–ø–ª–æ—è —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞—Ç–µ–∂–µ–π

echo "======================================"
echo "üí≥ –î–ï–ü–õ–û–ô –°–ò–°–¢–ï–ú–´ –ü–õ–ê–¢–ï–ñ–ï–ô"
echo "======================================"
echo ""

# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip install yookassa==3.3.0 fastapi==0.115.4 uvicorn[standard]==0.32.0 pydantic==2.9.2
echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
echo ""

# 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏
echo "üóÑÔ∏è  –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î..."
python apply_subscription_migration.py
echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞"
echo ""

# 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
echo "üß™ –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
python test_payment_system.py
echo ""

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
echo "üîç –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤..."
if command -v ufw &> /dev/null; then
    echo "–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç 8000..."
    sudo ufw allow 8000/tcp
    sudo ufw status | grep 8000
fi
echo ""

# 5. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
echo "======================================"
echo "üìù –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo "======================================"
echo ""
echo "1. –î–æ–±–∞–≤—å—Ç–µ –≤ .env:"
echo "   WEBHOOK_URL=http://–≤–∞—à-ip:8000/webhook/yookassa"
echo ""
echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ webhook —Å–µ—Ä–≤–µ—Ä:"
echo "   python webhook_server.py"
echo ""
echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook –≤ –ÆKassa:"
echo "   https://yookassa.ru/my/shop-settings"
echo "   URL: http://–≤–∞—à-ip:8000/webhook/yookassa"
echo "   –°–æ–±—ã—Ç–∏—è: payment.succeeded, payment.canceled"
echo ""
echo "4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:"
echo "   python main.py"
echo ""
echo "5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–ª–∞—Ç—ë–∂ –≤ Telegram –±–æ—Ç–µ"
echo ""
echo "======================================"
echo "‚ú® –ì–û–¢–û–í–û!"
echo "======================================"
