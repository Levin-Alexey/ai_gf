# üö® –°–†–û–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´ –ü–õ–ê–¢–ï–ñ–ï–ô

## ‚úÖ –ß–¢–û –ë–´–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### 1. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ `webhook_server.py`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `update()` –∑–∞–ø—Ä–æ—Å SQLAlchemy, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º–∏ —Å–µ—Å—Å–∏—è–º–∏.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```python
# ‚ùå –°–¢–ê–†–´–ô –ö–û–î (–ù–ï –†–ê–ë–û–¢–ê–õ):
stmt = (
    update(User)
    .where(User.telegram_id == telegram_id)
    .values(subscription_expires_at=expires_at)
)
await session.execute(stmt)
await session.commit()

# ‚úÖ –ù–û–í–´–ô –ö–û–î (–†–ê–ë–û–¢–ê–ï–¢):
user.subscription_expires_at = expires_at
session.add(user)
await session.commit()
await session.refresh(user)
```

### 2. –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ:
- –ü–æ–ª—É—á–µ–Ω–∏–µ webhook –æ—Ç –ÆKassa
- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ metadata (telegram_id, days)
- –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

### 3. –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
- –ù–∞–ª–∏—á–∏–µ telegram_id –∏ days –≤ metadata
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö (int)
- –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î

---

## üîÑ –ö–ê–ö –ü–†–ò–ú–ï–ù–ò–¢–¨ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ù–∞ –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ (—É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ)
–ò–∑–º–µ–Ω–µ–Ω–∏—è —É–∂–µ –≤–Ω–µ—Å–µ–Ω—ã –≤ —Ñ–∞–π–ª `webhook_server.py`.

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä–µ

```bash
# 1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh user@your-server.com

# 2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /path/to/AI_GF

# 3. –°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
cp webhook_server.py webhook_server.py.backup

# 4. –°–∫–∞—á–∞–π—Ç–µ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git pull origin main

# 5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ webhook —Å–µ—Ä–≤–µ—Ä
sudo systemctl restart ai-gf-webhook.service

# 6. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
sudo journalctl -u ai-gf-webhook.service -f
```

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É
```bash
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å venv
.\venv\Scripts\Activate.ps1

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
python diagnose_payment_system.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!
   –°–∏—Å—Ç–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ.
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
python test_webhook_locally.py <telegram_id> check

# –ù–∞–ø—Ä–∏–º–µ—Ä:
python test_webhook_locally.py 562882506 check
```

### 3. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
```bash
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 30 –¥–Ω–µ–π
python test_webhook_locally.py <telegram_id> activate

# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 7 –¥–Ω–µ–π (–¥–ª—è —Ç–µ—Å—Ç–∞)
python test_webhook_locally.py <telegram_id> activate 7
```

---

## üîç –ö–ê–ö –ü–†–û–í–ï–†–ò–¢–¨, –ß–¢–û –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: `/start`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –º–µ–Ω—é: `/pay` –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ "üíé –ü–æ–¥–ø–∏—Å–∫–∞"
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ "1 –º–µ—Å—è—Ü ‚Äî 299‚ÇΩ"
4. **–ù–ï –û–ü–õ–ê–ß–ò–í–ê–ô–¢–ï**, –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
sudo journalctl -u ai-gf-webhook.service -f
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
- `üì® –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: payment.succeeded`
- `üí∞ –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ ID: ...`
- `‚è≥ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è <telegram_id> –Ω–∞ 30 –¥–Ω–µ–π...`
- `‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞/–ø—Ä–æ–¥–ª–µ–Ω–∞`

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î
```bash
# –ß–µ—Ä–µ–∑ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç
python test_webhook_locally.py <telegram_id> check
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
```
‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ê–ö–¢–ò–í–ù–ê (–æ—Å—Ç–∞–ª–æ—Å—å X –¥–Ω–µ–π)
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ü–†–û–ë–õ–ï–ú–´

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- 914 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î
- 2 –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ (0.22%)
- –ü–ª–∞—Ç–µ–∂–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∞—Å—å

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
–ü–ª–∞—Ç–µ–∂–∏ –¥–æ–ª–∂–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å—Å—è –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.

---

## üêõ –ß–¢–û –î–ï–õ–ê–¢–¨, –ï–°–õ–ò –ü–†–û–ë–õ–ï–ú–ê –ù–ï –†–ï–®–ï–ù–ê

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Webhook –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ —Å–µ—Ä–≤–µ—Ä–∞

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ—Ä–≤–µ—Ä
curl http://localhost:8000/health

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏–∑–≤–Ω–µ
curl https://pay.aigirlfriendbot.ru/webhook/yookassa
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å firewall
- –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ webhook URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ÆKassa

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Webhook –¥–æ—Ö–æ–¥–∏—Ç, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:**
```bash
sudo journalctl -u ai-gf-webhook.service -n 100
```

**–ò—Å–∫–∞—Ç—å:**
- `‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ... –Ω–µ –Ω–∞–π–¥–µ–Ω` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª –±–æ—Ç–∞
- `‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê` ‚Äî –æ—à–∏–±–∫–∞ –ë–î
- `‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç telegram_id –∏–ª–∏ days` ‚Äî –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π metadata

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞ (`/start`)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î: `python diagnose_payment_system.py`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ metadata –≤ –∫–æ–¥–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ (`handlers/payment.py`)

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è, –Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –í .env —Ñ–∞–π–ª–µ
BOT_TOKEN=...
```

**–†–µ—à–µ–Ω–∏–µ:**
–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `BOT_TOKEN` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.

---

## üìû –ë–´–°–¢–†–´–ï –ö–û–ú–ê–ù–î–´

```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã
python diagnose_payment_system.py

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
python test_webhook_locally.py <telegram_id> check

# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é
python test_webhook_locally.py <telegram_id> activate 30

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å webhook —Å–µ—Ä–≤–µ—Ä
sudo systemctl restart ai-gf-webhook.service

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
sudo journalctl -u ai-gf-webhook.service -f

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
sudo systemctl status ai-gf-webhook.service
```

---

## ‚úÖ –ß–ï–ö–õ–ò–°–¢ –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø

- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥ –≤ `webhook_server.py`
- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- [x] –°–æ–∑–¥–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —Ä–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂
- [ ] –ö–æ–¥ –∑–∞–¥–µ–ø–ª–æ–µ–Ω –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω
- [ ] Webhook —Å–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ª–æ–≥–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

---

## üìù –ü–†–ò–ú–ï–ß–ê–ù–ò–Ø

1. **–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:** –ü–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–¥–µ–ª–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ë–î
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ health check endpoint
3. **–õ–æ–≥–∏:** –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–æ—Ç–∞—Ü–∏—é –ª–æ–≥–æ–≤, —á—Ç–æ–±—ã –Ω–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∏—Å–∫
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook –≤–∫–ª—é—á–µ–Ω–∞ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

---

–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: **21 –Ω–æ—è–±—Ä—è 2025**
–í–µ—Ä—Å–∏—è: **1.0.1**
