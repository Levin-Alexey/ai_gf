# üî• –ü–û–®–ê–ì–û–í–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê RABBITMQ –ù–ê VDS –°–ï–†–í–ï–†–ï 5.23.53.246
# –ü–æ–¥–∫–ª—é—á–∏—Å—å –ø–æ SSH: ssh root@5.23.53.246

# =====================================================
# 1. –ü–†–û–í–ï–†–Ø–ï–ú –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–°
# =====================================================
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å RabbitMQ..."
sudo systemctl status rabbitmq-server

echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Redis (—á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –Ω–µ —Ç—Ä–æ–≥–∞–µ–º)..."
sudo systemctl status redis-server

# =====================================================
# 2. –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú –ò –ó–ê–ü–£–°–ö–ê–ï–ú RABBITMQ
# =====================================================
echo "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º RabbitMQ –µ—Å–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω..."
sudo apt update
sudo apt install -y rabbitmq-server

echo "–ó–∞–ø—É—Å–∫–∞–µ–º RabbitMQ..."
sudo systemctl start rabbitmq-server
sudo systemctl enable rabbitmq-server

# =====================================================
# 3. –°–û–ó–î–ê–ï–ú –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ADMIN
# =====================================================
echo "–£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è admin –µ—Å–ª–∏ –µ—Å—Ç—å..."
sudo rabbitmqctl delete_user admin 2>/dev/null || true

echo "–°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è admin..."
sudo rabbitmqctl add_user admin 'T7#mQ$vP2@wL9$nR6zE8*bY5cN3'
sudo rabbitmqctl set_user_tags admin administrator
sudo rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"

# =====================================================
# 4. –ù–ê–°–¢–†–ê–ò–í–ê–ï–ú –ö–û–ù–§–ò–ì –î–õ–Ø –í–ù–ï–®–ù–ò–• –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ô
# =====================================================
echo "–°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–∞..."
sudo mkdir -p /etc/rabbitmq

echo "–°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥ —Ñ–∞–π–ª..."
sudo tee /etc/rabbitmq/rabbitmq.conf << 'EOF'
# –†–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å –ª—é–±—ã—Ö IP –∞–¥—Ä–µ—Å–æ–≤
listeners.tcp.default = 5672
listeners.tcp.1 = 0.0.0.0:5672

# –û—Ç–∫–ª—é—á–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
loopback_users = none

# –£–≤–µ–ª–∏—á–∏—Ç—å heartbeat –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
heartbeat = 60

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log.file.level = info
log.console = true
log.console.level = info

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
tcp_listen_options.backlog = 128
tcp_listen_options.nodelay = true
tcp_listen_options.keepalive = true
tcp_listen_options.exit_on_close = false

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–º—è—Ç–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
vm_memory_high_watermark.relative = 0.6
disk_free_limit.relative = 1.0
EOF

# =====================================================
# 5. –û–¢–ö–†–´–í–ê–ï–ú –ü–û–†–¢–´ –í –§–ê–ô–†–í–û–õ–ï
# =====================================================
echo "–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–∞–π—Ä–≤–æ–ª..."

# –î–ª—è Ubuntu/Debian (UFW)
if command -v ufw >/dev/null 2>&1; then
    echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º UFW —Ñ–∞–π—Ä–≤–æ–ª..."
    sudo ufw allow 5672/tcp comment 'RabbitMQ AMQP'
    sudo ufw allow 15672/tcp comment 'RabbitMQ Management'
    sudo ufw --force enable
    sudo ufw status
fi

# –î–ª—è CentOS/RHEL (firewalld)
if command -v firewall-cmd >/dev/null 2>&1; then
    echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º firewalld..."
    sudo firewall-cmd --add-port=5672/tcp --permanent --zone=public
    sudo firewall-cmd --add-port=15672/tcp --permanent --zone=public
    sudo firewall-cmd --reload
    sudo firewall-cmd --list-all
fi

# =====================================================
# 6. –í–ö–õ–Æ–ß–ê–ï–ú –í–ï–ë-–ò–ù–¢–ï–†–§–ï–ô–° –£–ü–†–ê–í–õ–ï–ù–ò–Ø
# =====================================================
echo "–í–∫–ª—é—á–∞–µ–º –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."
sudo rabbitmq-plugins enable rabbitmq_management

# =====================================================
# 7. –ü–ï–†–ï–ó–ê–ü–£–°–ö–ê–ï–ú RABBITMQ
# =====================================================
echo "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º RabbitMQ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫..."
sudo systemctl restart rabbitmq-server

echo "–ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (15 —Å–µ–∫—É–Ω–¥)..."
sleep 15

# =====================================================
# 8. –ü–†–û–í–ï–†–Ø–ï–ú –†–ï–ó–£–õ–¨–¢–ê–¢
# =====================================================
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–ª—É–∂–±..."
sudo systemctl status rabbitmq-server --no-pager
sudo systemctl status redis-server --no-pager

echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π RabbitMQ..."
sudo rabbitmqctl list_users

echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞..."
sudo rabbitmqctl list_permissions -p /

echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã..."
sudo netstat -tulpn | grep -E ':(5672|6379|15672)' || sudo ss -tulpn | grep -E ':(5672|6379|15672)'

echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞–≥–∏–Ω—ã..."
sudo rabbitmq-plugins list

echo ""
echo "‚úÖ –ù–ê–°–¢–†–û–ô–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "üîó RabbitMQ AMQP: 5.23.53.246:5672"
echo "üåê RabbitMQ Web UI: http://5.23.53.246:15672"
echo "üë§ –õ–æ–≥–∏–Ω: admin"
echo "üîê –ü–∞—Ä–æ–ª—å: T7#mQ\$vP2@wL9\$nR6zE8*bY5cN3"
echo "üîó Redis: 5.23.53.246:6379 (–Ω–µ –∏–∑–º–µ–Ω–µ–Ω)"
echo ""
echo "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞!"