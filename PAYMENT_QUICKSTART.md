# üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞—Ç–µ–∂–µ–π

## ‚úÖ –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ

1. ‚úÖ **–ú–æ–¥–µ–ª–∏ –ë–î** - –ø–æ–ª–µ `subscription_expires_at` –≤ —Ç–∞–±–ª–∏—Ü–µ `users`
2. ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤** - 5 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
3. ‚úÖ **Webhook —Å–µ—Ä–≤–µ—Ä** - `webhook_server.py` –¥–ª—è –ø—Ä–∏—ë–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –ÆKassa
4. ‚úÖ **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–ø–ª–∞—Ç—ã** - `handlers/payment.py` —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ÆKassa API
5. ‚úÖ **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** - –ÆKassa –∫–ª—é—á–∏ –≤ `.env`

---

## üìù –®–∞–≥–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞

### 1Ô∏è‚É£ –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)

**Windows:**
```bash
.\install_payment_deps.bat
```

**–ò–ª–∏ –≤—Ä—É—á–Ω—É—é:**
```bash
.\venv\Scripts\pip.exe install yookassa==3.3.0
.\venv\Scripts\pip.exe install fastapi==0.115.4
.\venv\Scripts\pip.exe install uvicorn[standard]==0.32.0
.\venv\Scripts\pip.exe install pydantic==2.9.2
```

---

### 2Ô∏è‚É£ –î–æ–±–∞–≤–∏—Ç—å WEBHOOK_URL –≤ .env

–û—Ç–∫—Ä–æ–π—Ç–µ `.env` –∏ –¥–æ–±–∞–≤—å—Ç–µ:
```env
WEBHOOK_URL=http://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä-ip:8000/webhook/yookassa
```

‚ö†Ô∏è **–ó–∞–º–µ–Ω–∏—Ç–µ `–≤–∞—à-—Å–µ—Ä–≤–µ—Ä-ip` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π IP/–¥–æ–º–µ–Ω!**

–ü—Ä–∏–º–µ—Ä:
```env
WEBHOOK_URL=http://72.56.69.63:8000/webhook/yookassa
```

---

### 3Ô∏è‚É£ –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç 8000 –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**Ubuntu/Debian:**
```bash
sudo ufw allow 8000/tcp
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
sudo ufw status
```

---

### 4Ô∏è‚É£ –ó–∞–ø—É—Å—Ç–∏—Ç—å webhook —Å–µ—Ä–≤–µ—Ä

**–õ–æ–∫–∞–ª—å–Ω–æ (–¥–ª—è —Ç–µ—Å—Ç–∞):**
```bash
.\venv\Scripts\python.exe webhook_server.py
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:**
```bash
curl http://localhost:8000/health
```

–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å:
```json
{"status":"healthy","timestamp":"2025-10-22T..."}
```

---

### 5Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ –ÆKassa

1. –í–æ–π–¥–∏—Ç–µ: https://yookassa.ru/my/shop-settings
2. –ù–∞–π–¥–∏—Ç–µ **"HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è"**
3. –î–æ–±–∞–≤—å—Ç–µ URL: `http://–≤–∞—à-—Å–µ—Ä–≤–µ—Ä:8000/webhook/yookassa`
4. –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±—ã—Ç–∏—è:
   - ‚úÖ `payment.succeeded`
   - ‚úÖ `payment.canceled`
5. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

---

### 6Ô∏è‚É£ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç—ë–∂

**–í –±–æ—Ç–µ:**
1. `/start`
2. "üí¨ –ù–∞—á–∞—Ç—å —á–∞—Ç"
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ 6 —Å–æ–æ–±—â–µ–Ω–∏–π (–ø—Ä–µ–≤—ã—Å–∏—Ç–µ –ª–∏–º–∏—Ç)
4. –ù–∞–∂–º–∏—Ç–µ "üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
5. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ
6. –û–ø–ª–∞—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π:
   - **–ù–æ–º–µ—Ä:** 5555 5555 5555 4444
   - **–°—Ä–æ–∫:** 12/24
   - **CVC:** 123

**–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã:**
- Webhook –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
- –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- –õ–∏–º–∏—Ç —Å–Ω–∏–º–µ—Ç—Å—è (–±–µ–∑–ª–∏–º–∏—Ç)

---

### 7Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

**Webhook —Å–µ—Ä–≤–µ—Ä (–≤ –∫–æ–Ω—Å–æ–ª–∏):**
```
INFO - üì® –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: payment.succeeded
INFO - ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è 782769400 –Ω–∞ 30 –¥–Ω–µ–π
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤ –ë–î:**
```bash
.\venv\Scripts\python.exe -c "import asyncio; from database import async_session_maker; from crud import get_user_by_telegram_id; async def check(): async with async_session_maker() as s: u = await get_user_by_telegram_id(s, 782769400); print(f'–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ: {u.subscription_expires_at}'); asyncio.run(check())"
```

---

## üî• Production –∑–∞–ø—É—Å–∫ (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

### –°–æ–∑–¥–∞—Ç—å systemd —Å–µ—Ä–≤–∏—Å—ã

**`/etc/systemd/system/ai-gf-webhook.service`:**
```ini
[Unit]
Description=AI GF Payment Webhook
After=network.target

[Service]
Type=simple
User=your_user
WorkingDirectory=/path/to/AI_GF
ExecStart=/path/to/AI_GF/venv/bin/python webhook_server.py
Restart=always

[Install]
WantedBy=multi-user.target
```

**–ó–∞–ø—É—Å–∫:**
```bash
sudo systemctl daemon-reload
sudo systemctl enable ai-gf-webhook
sudo systemctl start ai-gf-webhook
sudo systemctl status ai-gf-webhook
```

---

## üß™ –¢–µ—Å—Ç–æ–≤—ã–π webhook (–±–µ–∑ –æ–ø–ª–∞—Ç—ã)

–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞–ø—Ä—è–º—É—é:

```bash
curl -X POST http://localhost:8000/webhook/test \
  -H "Content-Type: application/json" \
  -d '{"telegram_id": 782769400, "days": 30}'
```

‚ö†Ô∏è **–≠—Ç–æ—Ç endpoint –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å! –û—Ç–∫–ª—é—á–∏—Ç–µ –≤ production!**

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook —Å–µ—Ä–≤–µ—Ä–∞
```bash
curl http://localhost:8000/health
```

### –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ
sudo journalctl -u ai-gf-webhook -f

# –õ–æ–∫–∞–ª—å–Ω–æ
python webhook_server.py  # —Å–º–æ—Ç—Ä–∏—Ç–µ –∫–æ–Ω—Å–æ–ª—å
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚úÖ Webhook **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å
- ‚úÖ –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `.env` (–Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—å –≤ git!)
- ‚úÖ –î–ª—è production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS (nginx + SSL)

### –ü–æ—Ä—Ç—ã
- **8000** - webhook —Å–µ—Ä–≤–µ—Ä (–Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –≤ firewall)
- **80/443** - nginx (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ HTTPS)

### –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫
- ‚úÖ **–ë–æ—Ç** –∏ **webhook** –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é—Ç **—Ä–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã** (–Ω–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞)
- ‚úÖ –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:** `YOOKASSA_SETUP.md`
- **–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫:** `SUBSCRIPTION_SYSTEM.md`
- **–ÆKassa API:** https://yookassa.ru/developers/api

---

## üéØ Checklist

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —É–±–µ–¥–∏—Ç–µ—Å—å:

- [ ] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (yookassa, fastapi, uvicorn)
- [ ] –î–æ–±–∞–≤–ª–µ–Ω `WEBHOOK_URL` –≤ `.env`
- [ ] –û—Ç–∫—Ä—ã—Ç –ø–æ—Ä—Ç 8000 –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- [ ] –ó–∞–ø—É—â–µ–Ω webhook —Å–µ—Ä–≤–µ—Ä (`python webhook_server.py`)
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω webhook –≤ –ÆKassa –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ª–æ–≥–∏ webhook —Å–µ—Ä–≤–µ—Ä–∞

---

## ‚ú® –í—Å—ë –≥–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å —Å–∏—Å—Ç–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç:
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ª–∏–º–∏—Ç ‚Üí –≤–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É –ø–æ–¥–ø–∏—Å–∫–∏
2. –í—ã–±–∏—Ä–∞–µ—Ç —Ç–∞—Ä–∏—Ñ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –æ–ø–ª–∞—Ç–µ –ÆKassa
3. –û–ø–ª–∞—á–∏–≤–∞–µ—Ç ‚Üí webhook –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
4. –ü–æ–ª—É—á–∞–µ—Ç –±–µ–∑–ª–∏–º–∏—Ç! üéâ

**–í–æ–ø—Ä–æ—Å—ã?** –°–º–æ—Ç—Ä–∏—Ç–µ `YOOKASSA_SETUP.md` üìñ
