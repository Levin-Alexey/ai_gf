"""
–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–æ—Ç–∞
"""
import logging
from aiogram import Router, F
from aiogram.types import CallbackQuery
from aiogram.types import (
    Message,
    ReplyKeyboardMarkup,
    KeyboardButton,
    InlineKeyboardMarkup,
    InlineKeyboardButton
)

from database import async_session_maker
from crud import get_user_by_telegram_id

router = Router()
logger = logging.getLogger(__name__)


def get_main_menu_keyboard():
    """–°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üí¨ –ù–∞—á–∞—Ç—å —á–∞—Ç")],
            [KeyboardButton(text="üí≥ –û–ø–ª–∞—Ç–∞")],
            [KeyboardButton(text="‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")],
        ],
        resize_keyboard=True,
        one_time_keyboard=False
    )
    return keyboard


async def show_main_menu(message: Message, user_name: str):
    """–ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    await message.answer(
        f"–ü—Ä–∏–≤–µ—Ç, {user_name}! üëã\n\n"
        "–†–∞–¥–∞ –≤–∏–¥–µ—Ç—å —Ç–µ–±—è! ‚ú®\n"
        "–í—ã–±–µ—Ä–∏, —á—Ç–æ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å:",
        reply_markup=get_main_menu_keyboard()
    )


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å —á–∞—Ç" –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ handlers/chat.py


@router.message(F.text == "üí≥ –û–ø–ª–∞—Ç–∞")
async def handle_payment(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–û–ø–ª–∞—Ç–∞'"""
    await message.answer(
        "üí≥ –û–ø–ª–∞—Ç–∞ –∏ –ø–æ–¥–ø–∏—Å–∫–∏\n\n"
        "–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ... –°–∫–æ—Ä–æ –∑–¥–µ—Å—å –±—É–¥—É—Ç —Ç–∞—Ä–∏—Ñ—ã! üíé"
    )


def get_settings_keyboard():
    """–°–æ–∑–¥–∞—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
    keyboard = ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üé® –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä")],
            [KeyboardButton(text="ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞")],
            [KeyboardButton(text="üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é")],
        ],
        resize_keyboard=True,
        one_time_keyboard=False
    )
    return keyboard


@router.message(F.text == "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
async def handle_settings(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'"""
    logger.info(f"‚öôÔ∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ '–ù–∞—Å—Ç—Ä–æ–π–∫–∏' –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {message.from_user.id}")
    async with async_session_maker() as session:
        user = await get_user_by_telegram_id(
            session,
            telegram_id=message.from_user.id
        )

    if user:
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
        tone_text = user.tone.value if user.tone else "–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        interests_count = len(user.interests) if user.interests else 0
        goals_count = len(user.goals) if user.goals else 0

        settings_text = (
            f"‚öôÔ∏è –¢–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n\n"
            f"üé® –¢–æ–Ω –æ–±—â–µ–Ω–∏—è: {tone_text}\n"
            f"üéØ –ò–Ω—Ç–µ—Ä–µ—Å–æ–≤: {interests_count}\n"
            f"üéØ –¶–µ–ª–µ–π: {goals_count}\n"
            f"üìù –û —Å–µ–±–µ: {'–ó–∞–ø–æ–ª–Ω–µ–Ω–æ' if user.about else '–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ'}\n\n"
            f"–í—ã–±–µ—Ä–∏, —á—Ç–æ —Ö–æ—á–µ—à—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:"
        )
        
        # –°–æ–∑–¥–∞–µ–º inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [InlineKeyboardButton(text="üé® –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä", callback_data="character_settings")],
                [InlineKeyboardButton(text="ü§ñ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞", callback_data="bot_settings")],
                [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="back_to_main")]
            ]
        )
        
        await message.answer(
            settings_text,
            reply_markup=keyboard
        )
    else:
        await message.answer(
            "‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫—É. –ù–∞–ø–∏—à–∏ /start"
        )


@router.message(F.text == "üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é")
async def handle_back_to_menu(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é'"""
    user_name = (
        message.from_user.first_name or "–¥—Ä—É–≥"
        if message.from_user else "–¥—Ä—É–≥"
    )
    await show_main_menu(message, user_name)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ inline –∫–Ω–æ–ø–æ–∫
@router.callback_query(F.data == "character_settings")
async def handle_character_settings_callback(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä'"""
    logger.info(f"üé® –ü–æ–ª—É—á–µ–Ω callback 'character_settings' –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {callback.from_user.id}")
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç Message —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º from_user
    from aiogram.types import Message
    message = Message(
        message_id=callback.message.message_id,
        from_user=callback.from_user,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º from_user –∏–∑ callback
        chat=callback.message.chat,
        date=callback.message.date,
        content_type=callback.message.content_type,
        text=callback.message.text,
        reply_markup=callback.message.reply_markup
    )
    
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ character_settings
    from .character_settings import handle_character_settings
    await handle_character_settings(message)
    await callback.answer()


@router.callback_query(F.data == "bot_settings")
async def handle_bot_settings_callback(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞'"""
    logger.info(f"ü§ñ –ü–æ–ª—É—á–µ–Ω callback 'bot_settings' –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {callback.from_user.id}")
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç Message —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º from_user
    from aiogram.types import Message
    message = Message(
        message_id=callback.message.message_id,
        from_user=callback.from_user,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º from_user –∏–∑ callback
        chat=callback.message.chat,
        date=callback.message.date,
        content_type=callback.message.content_type,
        text=callback.message.text,
        reply_markup=callback.message.reply_markup
    )
    
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ bot_settings
    from .bot_settings import handle_bot_settings
    await handle_bot_settings(message)
    await callback.answer()


@router.callback_query(F.data == "back_to_main")
async def handle_back_to_main_callback(callback: CallbackQuery):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ '–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é'"""
    logger.info(f"üîô –ü–æ–ª—É—á–µ–Ω callback 'back_to_main' –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {callback.from_user.id}")
    
    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å inline –∫–Ω–æ–ø–∫–∞–º–∏
    await callback.message.delete()
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç Message —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º from_user
    from aiogram.types import Message
    message = Message(
        message_id=callback.message.message_id,
        from_user=callback.from_user,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º from_user –∏–∑ callback
        chat=callback.message.chat,
        date=callback.message.date,
        content_type=callback.message.content_type,
        text=callback.message.text,
        reply_markup=callback.message.reply_markup
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    user_name = callback.from_user.first_name or "–¥—Ä—É–≥"
    await show_main_menu(message, user_name)
    await callback.answer()
