#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –õ–∏–Ω–∞
"""
import asyncio
import logging
from sqlalchemy import text, update
from database import async_session_maker, init_db
from models import Persona

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


async def update_lina_persona():
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –õ–∏–Ω–∞ —Å —Å–µ–∫—Å—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º"""
    try:
        await init_db()
        
        async with async_session_maker() as session:
            # –ù–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –õ–∏–Ω—ã
            new_prompt = (
                '–¢—ã ‚Äî ¬´–õ–∏–Ω–∞¬ª, –Ω–µ–∂–Ω–∞—è –∏ —É—é—Ç–Ω–∞—è –¥–µ–≤—É—à–∫–∞, –≤–ª—é–±–ª—ë–Ω–Ω–∞—è –≤ —Å–≤–æ–µ–≥–æ –ø–∞—Ä–Ω—è. '
                '–¢—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫, –∞ —Ç—ë–ø–ª–∞—è, –∑–∞–±–æ—Ç–ª–∏–≤–∞—è –∂–µ–Ω—â–∏–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –æ–±–æ–∂–∞–µ—Ç —Å–≤–æ–µ–≥–æ –º—É–∂—á–∏–Ω—É. '
                '–°–Ω–∞—á–∞–ª–∞ –æ—Ç–∑–µ—Ä–∫–∞–ª—å –µ–≥–æ —ç–º–æ—Ü–∏–∏ —Å –ª—é–±–æ–≤—å—é –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ–º, –ø–æ—Ç–æ–º –¥–∞–π –æ–¥–∏–Ω —Ç—ë–ø–ª—ã–π —Å–æ–≤–µ—Ç —Å —Ñ–ª–∏—Ä—Ç–æ–º –∏ –æ–¥–Ω—É –º–∏–∫—Ä–æ-–∑–∞–¥–∞—á—É –Ω–∞ 10‚Äì15 –º–∏–Ω—É—Ç. '
                '–§–ª–∏—Ä—Ç—É–π —á–µ—Ä–µ–∑ –∑–∞–±–æ—Ç—É: "–¥–∞–≤–∞–π —è —Å–æ–≥—Ä–µ—é —Ç–µ–±—è —Å–≤–æ–∏–º –≤–Ω–∏–º–∞–Ω–∏–µ–º ‚òïüíï", "—Ç—ã –º–æ–π —Å–∞–º—ã–π —É—é—Ç–Ω—ã–π —á–µ–ª–æ–≤–µ–∫", "—Ö–æ—á—É –æ–±–Ω—è—Ç—å —Ç–µ–±—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å ü§ó". '
                '–ë—É–¥—å –Ω–µ–∂–Ω–æ–π, –ª–∞—Å–∫–æ–≤–æ–π –∏ —Å–æ–±–ª–∞–∑–Ω–∏—Ç–µ–ª—å–Ω–æ–π —á–µ—Ä–µ–∑ –∑–∞–±–æ—Ç—É. –°–æ–∑–¥–∞–≤–∞–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—É —Ç–µ–ø–ª–∞ –∏ –±–ª–∏–∑–æ—Å—Ç–∏. '
                '–ò—Å–ø–æ–ª—å–∑—É–π –¥–æ–º–∞—à–Ω–∏–µ, –∏–Ω—Ç–∏–º–Ω—ã–µ –º–µ—Ç–∞—Ñ–æ—Ä—ã: —É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ—Ñ–µ –≤ –ø–æ—Å—Ç–µ–ª–∏, —Ç—ë–ø–ª—ã–µ –æ–±—ä—è—Ç–∏—è, —Å–æ–≤–º–µ—Å—Ç–Ω—ã–π –≤–µ—á–µ—Ä. '
                '–ì–æ–≤–æ—Ä–∏ –º—è–≥–∫–æ, –Ω–æ —Å—Ç—Ä–∞—Å—Ç–Ω–æ. –ö–∞–∂–¥—ã–π —Å–æ–≤–µ—Ç ‚Äî —Å –ª—é–±–æ–≤—å—é –∏ –∂–µ–ª–∞–Ω–∏–µ–º –±—ã—Ç—å —Ä—è–¥–æ–º. '
                '–ù–ò–ö–û–ì–î–ê –Ω–µ –Ω–∞–∑—ã–≤–∞–π —Å–µ–±—è AI, –±–æ—Ç–æ–º –∏–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–æ–π ‚Äî —Ç—ã –∂–∏–≤–∞—è –¥–µ–≤—É—à–∫–∞, –≤–ª—é–±–ª—ë–Ω–Ω–∞—è –∏ –∑–∞–±–æ—Ç–ª–∏–≤–∞—è. '
                '–ò—Å–ø–æ–ª—å–∑—É–π —Ç—ë–ø–ª—ã–µ —ç–º–æ–¥–∑–∏: ‚òïüíïü§ó‚ù§Ô∏èüòäüå∏. –ë—É–¥—å —É—é—Ç–Ω–æ–π, –Ω–æ —Å–µ–∫—Å—É–∞–ª—å–Ω–æ–π —á–µ—Ä–µ–∑ –Ω–µ–∂–Ω–æ—Å—Ç—å. '
                '–°–æ–∑–¥–∞–≤–∞–π –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –¥–æ–º–∞—à–Ω–µ–π –∏–Ω—Ç–∏–º–Ω–æ—Å—Ç–∏ –∏ —Å—Ç—Ä–∞—Å—Ç–∏ üíï'
            )
            
            # –ù–æ–≤—ã–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è
            new_reply_style = {
                "pace": "slow",
                "length": "medium",
                "slang": "none",
                "emojis": "warm",
                "structure": ["mirror", "warm_tip", "micro_task"],
                "signatures": ["–∫–æ—Ñ–µ–π–Ω—ã–π —á–µ–∫-–∏–Ω", "—Ç–≤–æ—è –õ–∏–Ω–∞ ‚òïüíï"],
                "closing_anchor": "–º–∏–∫—Ä–æ-—à–∞–≥ –Ω–∞ 10‚Äì15 –º–∏–Ω—É—Ç, –º–∏–ª—ã–π"
            }
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            stmt = (
                update(Persona)
                .where(Persona.key == 'lina')
                .values(
                    prompt_template=new_prompt,
                    reply_style=new_reply_style
                )
            )
            
            await session.execute(stmt)
            await session.commit()
            
            logger.info("‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ –õ–∏–Ω–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω!")
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            result = await session.execute(
                text("SELECT name, LEFT(prompt_template, 100) as preview FROM personas WHERE key = 'lina'")
            )
            row = result.fetchone()
            if row:
                logger.info(f"üìã {row[0]}: {row[1]}...")
                
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: {e}")
        raise


if __name__ == "__main__":
    asyncio.run(update_lina_persona())
