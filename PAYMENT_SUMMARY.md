# üíé –°–∏—Å—Ç–µ–º–∞ –ü–ª–∞—Ç–µ–∂–µ–π - –ò—Ç–æ–≥–æ–≤–∞—è –°–≤–æ–¥–∫–∞

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `subscription_expires_at` –≤ —Ç–∞–±–ª–∏—Ü—É `users`
- ‚úÖ –°–æ–∑–¥–∞–Ω –∏–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ SQL –º–∏–≥—Ä–∞—Ü–∏—è: `add_subscription_field.sql`
- ‚úÖ –°–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è: `apply_subscription_migration.py`

### 2. **–°–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤**
- ‚úÖ 5 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- ‚úÖ –°—á—ë—Ç—á–∏–∫ –≤ Redis —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º TTL (24—á)
- ‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Å—Ç–∞—Ç–∫–µ ‚â§2 —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏ –≤ `utils.py`:
  - `check_message_limit()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
  - `get_subscription_status()` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏

### 3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ÆKassa**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π —á–µ—Ä–µ–∑ API
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ webhook
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook (HMAC SHA-256)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤ `handlers/payment.py`
- ‚úÖ Webhook —Å–µ—Ä–≤–µ—Ä –Ω–∞ FastAPI: `webhook_server.py`

### 4. **UI –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
- ‚úÖ –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ (1–º/3–º/1–≥)
- ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–ø–ª–∞—Ç–µ –ÆKassa
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

### 5. **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è**
- ‚úÖ `activate_sub.py` - —Ä—É—á–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ `manage_subscription.py` - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
- ‚úÖ `test_message_limit.py` - —Ç–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –ª–∏–º–∏—Ç–æ–≤
- ‚úÖ `test_payment_system.py` - —Ç–µ—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ÆKassa

---

## üìÅ –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ
- `webhook_server.py` - FastAPI —Å–µ—Ä–≤–µ—Ä –¥–ª—è webhook (–ø–æ—Ä—Ç 8000)
- `handlers/payment.py` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ–ø–ª–∞—Ç—ã (–æ–±–Ω–æ–≤–ª—ë–Ω)
- `utils.py` - —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–æ–≤ (–æ–±–Ω–æ–≤–ª—ë–Ω)
- `redis_client.py` - –º–µ—Ç–æ–¥—ã incr/expire (–æ–±–Ω–æ–≤–ª—ë–Ω)
- `models.py` - –ø–æ–ª–µ subscription_expires_at (–æ–±–Ω–æ–≤–ª—ë–Ω)
- `config.py` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ÆKassa (–æ–±–Ω–æ–≤–ª—ë–Ω)

### SQL –º–∏–≥—Ä–∞—Ü–∏–∏
- `add_subscription_field.sql` - SQL –º–∏–≥—Ä–∞—Ü–∏—è
- `apply_subscription_migration.py` - —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

### –°–∫—Ä–∏–ø—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- `activate_sub.py` - –±—ã—Å—Ç—Ä–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
- `manage_subscription.py` - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –º–µ–Ω—é

### –¢–µ—Å—Ç—ã
- `test_message_limit.py` - —Ç–µ—Å—Ç –ª–∏–º–∏—Ç–æ–≤
- `test_payment_system.py` - —Ç–µ—Å—Ç –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã

### –£—Å—Ç–∞–Ω–æ–≤–∫–∞
- `install_payment_deps.bat` - Windows
- `install_payment_deps.sh` - Linux/Mac
- `requirements.txt` - –æ–±–Ω–æ–≤–ª—ë–Ω

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `SUBSCRIPTION_SYSTEM.md` - —Å–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- `YOOKASSA_SETUP.md` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ÆKassa
- `PAYMENT_QUICKSTART.md` - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- `PAYMENT_SUMMARY.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (–¥–ª—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞)

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞
```bash
# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git pull

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
.\install_payment_deps.bat
```

### –®–∞–≥ 2: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
–î–æ–±–∞–≤–∏—Ç—å –≤ `.env`:
```env
PAYMENT_SHOP_ID=1181697
PAYMENT_SECRET_KEY=live_Ee4j3Lp9erVpLw6YTZSaqj-pEGvAVjGA0ZMi8pSPUog
WEBHOOK_URL=http://–≤–∞—à-ip:8000/webhook/yookassa
```

### –®–∞–≥ 3: –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
```bash
python apply_subscription_migration.py
```

### –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
python test_payment_system.py
```

### –®–∞–≥ 5: –ó–∞–ø—É—Å–∫
```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1: –ë–æ—Ç
python main.py

# –¢–µ—Ä–º–∏–Ω–∞–ª 2: Webhook
python webhook_server.py
```

### –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ÆKassa
1. https://yookassa.ru/my/shop-settings
2. HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Üí –î–æ–±–∞–≤–∏—Ç—å URL
3. `http://–≤–∞—à-ip:8000/webhook/yookassa`
4. –°–æ–±—ã—Ç–∏—è: `payment.succeeded`, `payment.canceled`

---

## üí∞ –¢–∞—Ä–∏—Ñ—ã

| –¢–∞—Ä–∏—Ñ | –¶–µ–Ω–∞ | –î–Ω–µ–π | –≠–∫–æ–Ω–æ–º–∏—è |
|-------|------|------|----------|
| 1 –º–µ—Å—è—Ü | 299‚ÇΩ | 30 | - |
| 3 –º–µ—Å—è—Ü–∞ | 699‚ÇΩ | 90 | -22% |
| 1 –≥–æ–¥ | 1999‚ÇΩ | 365 | -44% |

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ `handlers/payment.py`.

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
Telegram User
    ‚Üì
handlers/chat.py ‚Üí check_message_limit()
    ‚Üì
–õ–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω? ‚Üí –ö–Ω–æ–ø–∫–∞ "–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
    ‚Üì
handlers/payment.py ‚Üí –ÆKassa API (—Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞)
    ‚Üì
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç ‚Üí –ÆKassa
    ‚Üì
–ÆKassa ‚Üí webhook_server.py (POST /webhook/yookassa)
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ ‚Üí –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ë–î
    ‚Üì
users.subscription_expires_at = NOW() + days
    ‚Üì
check_message_limit() ‚Üí –ë–µ–∑–ª–∏–º–∏—Ç! ‚ú®
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–æ (–±–µ–∑ –æ–ø–ª–∞—Ç—ã)
```bash
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞–ø—Ä—è–º—É—é
python activate_sub.py 782769400 30

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç—ã
python test_message_limit.py
```

### –° —Ä–µ–∞–ª—å–Ω–æ–π –æ–ø–ª–∞—Ç–æ–π
1. –í –±–æ—Ç–µ: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å 6 —Å–æ–æ–±—â–µ–Ω–∏–π
2. –ù–∞–∂–∞—Ç—å "üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
3. –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ
4. –û–ø–ª–∞—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π: `5555 5555 5555 4444`
5. Webhook –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook
```bash
curl http://localhost:8000/health
# {"status":"healthy","timestamp":"..."}
```

### –õ–æ–≥–∏
```bash
# Webhook
sudo journalctl -u ai-gf-webhook -f

# –ë–æ—Ç
sudo journalctl -u ai-gf-bot -f
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏
```bash
python -c "
from database import async_session_maker
from crud import get_user_by_telegram_id
import asyncio

async def check():
    async with async_session_maker() as s:
        u = await get_user_by_telegram_id(s, 782769400)
        print(f'–ü–æ–¥–ø–∏—Å–∫–∞: {u.subscription_expires_at}')

asyncio.run(check())
"
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Webhook –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å HMAC SHA-256
- ‚úÖ –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –≤ `.env` (–Ω–µ –≤ git!)
- ‚úÖ –î–ª—è production: HTTPS —á–µ—Ä–µ–∑ nginx + Let's Encrypt
- ‚úÖ –ü–æ—Ä—Ç 8000 –∑–∞—â–∏—â—ë–Ω firewall (—Ç–æ–ª—å–∫–æ –≤—Ö–æ–¥—è—â–∏–π HTTP)

---

## üêõ Troubleshooting

### "Invalid signature"
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `PAYMENT_SECRET_KEY` –≤ `.env`

### Webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç 8000, URL –≤ –ÆKassa

### –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ metadata (telegram_id, days) –≤ –ø–ª–∞—Ç–µ–∂–µ

### –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞
‚Üí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `PAYMENT_SHOP_ID` –∏ `PAYMENT_SECRET_KEY`

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:** `PAYMENT_QUICKSTART.md`
- **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ÆKassa:** `YOOKASSA_SETUP.md`
- **–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫:** `SUBSCRIPTION_SYSTEM.md`
- **–ÆKassa API:** https://yookassa.ru/developers/api

---

## ‚ú® –ò—Ç–æ–≥–æ

üéâ **–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—á–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –ÆKassa!**

- ‚úÖ –õ–∏–º–∏—Ç—ã –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö (5 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å)
- ‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- ‚úÖ 3 —Ç–∞—Ä–∏—Ñ–∞ —Å —Å–∫–∏–¥–∫–∞–º–∏
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ webhook —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø–æ–¥–ø–∏—Å–∏
- ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å WEBHOOK_URL
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å webhook —Å–µ—Ä–≤–µ—Ä
4. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook –≤ –ÆKassa
5. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç—ë–∂
6. –ó–∞–ø—É—Å—Ç–∏—Ç—å —á–µ—Ä–µ–∑ systemd (production)

üöÄ **–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏—ë–º—É –¥–µ–Ω–µ–≥!**
