# üíé –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –ª–∏–º–∏—Ç–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.

## ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ë–ï–ó –ø–æ–¥–ø–∏—Å–∫–∏:
- ‚úÖ **5 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å—É—Ç–∫–∏** –±–µ—Å–ø–ª–∞—Ç–Ω–æ
- ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –æ—Å—Ç–∞—Ç–∫–µ 2 —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –º–µ–Ω–µ–µ
- üö´ –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ—Å–ª–µ 5-–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–¥–ø–∏—Å–∫–∏
- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –ª–∏–º–∏—Ç–∞ –∫–∞–∂–¥—ã–µ 24 —á–∞—Å–∞ (UTC)

### –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –° –ø–æ–¥–ø–∏—Å–∫–æ–π:
- ‚ôæÔ∏è **–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**
- üé≠ –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º
- ‚ö° –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (PostgreSQL)
```sql
-- –¢–∞–±–ª–∏—Ü–∞ users
ALTER TABLE users 
ADD COLUMN subscription_expires_at TIMESTAMP WITH TIME ZONE DEFAULT NULL;

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
CREATE INDEX idx_users_subscription ON users(subscription_expires_at) 
WHERE subscription_expires_at IS NOT NULL;
```

**–õ–æ–≥–∏–∫–∞:**
- `NULL` ‚Üí –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏
- –ü—Ä–æ—à–µ–¥—à–∞—è –¥–∞—Ç–∞ ‚Üí –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞
- –ë—É–¥—É—â–∞—è –¥–∞—Ç–∞ ‚Üí –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞

### 2. Redis (—Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π)
```
–ö–ª—é—á: msg_limit:{telegram_id}:{YYYY-MM-DD}
–ó–Ω–∞—á–µ–Ω–∏–µ: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (int)
TTL: 86400 —Å–µ–∫—É–Ω–¥ (24 —á–∞—Å–∞)

–ü—Ä–∏–º–µ—Ä:
msg_limit:782769400:2025-10-22 ‚Üí 3 (TTL: 18—á)
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ Redis:**
- ‚ö° –°–∫–æ—Ä–æ—Å—Ç—å: ~1ms –Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—é
- üïí TTL –∏–∑ –∫–æ—Ä–æ–±–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å)
- üí™ –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π `INCR`

### 3. –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    ‚Üì
handlers/chat.py ‚Üí handle_chat_message()
    ‚Üì
utils.check_message_limit(redis, user)
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ë–î ‚îÄ‚îÄ‚Üí –ï—Å—Ç—å? ‚Üí –ë–µ–∑–ª–∏–º–∏—Ç ‚úÖ
    ‚Üì –ù–µ—Ç
Redis: INCR msg_limit:{user_id}:{date}
    ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞: count > 5? ‚îÄ‚îÄ‚Üí –î–∞ ‚Üí –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ ‚ùå
    ‚Üì –ù–µ—Ç
–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ RabbitMQ ‚Üí LLM ‚úÖ
```

## üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### models.py
```python
class User(Base):
    # ...
    subscription_expires_at: Mapped[Optional[datetime]] = mapped_column(
        TIMESTAMP(timezone=True),
        nullable=True,
        default=None
    )
```

### utils.py
–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
- `check_message_limit(redis, user, daily_limit=5)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
- `get_subscription_status(user)` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏

### redis_client.py
–ù–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã:
- `incr(key)` - –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–∞
- `expire(key, seconds)` - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ TTL

### handlers/chat.py
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏–º–∏—Ç–∞ –≤ `handle_chat_message()`:
```python
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–º–∏—Ç
can_send, messages_left = await check_message_limit(redis_client, user)

if not can_send:
    # –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
    return

# –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –º–∞–ª–æ–º –æ—Å—Ç–∞—Ç–∫–µ
if 0 <= messages_left <= 2:
    await message.answer(f"‚ö†Ô∏è –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–π: {messages_left}")
```

### handlers/payment.py (–ù–û–í–´–ô)
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏:
- `handle_pay_button()` - –ø–æ–∫–∞–∑ —Ç–∞—Ä–∏—Ñ–æ–≤
- `handle_subscribe()` - –≤—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞ (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
- `handle_cancel_payment()` - –æ—Ç–º–µ–Ω–∞ –æ–ø–ª–∞—Ç—ã

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –ª–∏–º–∏—Ç–æ–≤
```bash
python test_message_limit.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
‚úÖ –ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏: 5 —Å–æ–æ–±—â–µ–Ω–∏–π ‚Üí –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞  
‚úÖ –° –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π: –±–µ–∑–ª–∏–º–∏—Ç  
‚úÖ –° –∏—Å—Ç—ë–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π: –≤–æ–∑–≤—Ä–∞—Ç –∫ –ª–∏–º–∏—Ç—É 5  

### –¢–µ—Å—Ç –≤ –±–æ—Ç–µ
1. –û—Ç–ø—Ä–∞–≤–∏—Ç—å 5 —Å–æ–æ–±—â–µ–Ω–∏–π –±–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏
2. –ù–∞ 6-–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ—è–≤–∏—Ç—Å—è –∫–Ω–æ–ø–∫–∞ "üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"
3. –ù–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É ‚Üí —É–≤–∏–¥–µ—Ç—å —Ç–∞—Ä–∏—Ñ—ã
4. –í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ ‚Üí —É–≤–∏–¥–µ—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –æ–ø–ª–∞—Ç—ã

## üí≥ –¢–∞—Ä–∏—Ñ—ã –ø–æ–¥–ø–∏—Å–∫–∏

| –ü–µ—Ä–∏–æ–¥ | –¶–µ–Ω–∞ | –≠–∫–æ–Ω–æ–º–∏—è |
|--------|------|----------|
| 1 –º–µ—Å—è—Ü | 299‚ÇΩ | - |
| 3 –º–µ—Å—è—Ü–∞ | 699‚ÇΩ | -22% |
| 1 –≥–æ–¥ | 1999‚ÇΩ | -44% |

## üîß TODO: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

1. **–í—ã–±—Ä–∞—Ç—å –ø–ª–∞—Ç—ë–∂–Ω—É—é —Å–∏—Å—Ç–µ–º—É:**
   - –ÆKassa (–†–æ—Å—Å–∏—è)
   - Stripe (–º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ)
   - Telegram Stars (–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞)

2. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ handlers/payment.py:**
   ```python
   # –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
   payment_link = await payment_provider.create_payment(
       amount=plan['price'],
       description=f"–ü–æ–¥–ø–∏—Å–∫–∞ {plan['name']}"
   )
   
   # Webhook –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã
   @router.post("/payment/webhook")
   async def payment_webhook(request):
       # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
       user.subscription_expires_at = now + timedelta(days=plan['days'])
       await session.commit()
   ```

3. **–î–æ–±–∞–≤–∏—Ç—å –≤ –ë–î:**
   ```sql
   -- –¢–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π
   CREATE TABLE payments (
       id BIGSERIAL PRIMARY KEY,
       user_id BIGINT REFERENCES users(id),
       amount DECIMAL(10,2),
       plan VARCHAR(10),
       status VARCHAR(20),
       created_at TIMESTAMP DEFAULT NOW()
   );
   ```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

### –¢–µ–∫—É—â–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- ‚úÖ –°—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Redis (TTL 24—á)
- ‚úÖ –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –ë–î
- ‚úÖ –õ–æ–≥–∏ —Å–æ–±—ã—Ç–∏–π (–ª–∏–º–∏—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç, –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞)

### –ë—É–¥—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏
- üìà –ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø–æ–¥–ø–∏—Å–∫—É (—Å–∫–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫—É–ø–∏–ª–∏ –ø–æ—Å–ª–µ –ª–∏–º–∏—Ç–∞)
- üí∞ –°—Ä–µ–¥–Ω–∏–π —á–µ–∫ –ø–æ–¥–ø–∏—Å–∫–∏
- üîÑ Retention –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ (–ø—Ä–æ–¥–ª–µ–Ω–∏—è)
- üìä –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —Ç–∞—Ä–∏—Ñ–æ–≤

## üöÄ –ó–∞–ø—É—Å–∫

### –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î
```bash
python apply_subscription_migration.py
```

### –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
```bash
python main.py
```

### –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–æ—Ä–∫–µ—Ä–∞
```bash
python llm_worker.py
```

## üéØ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
```python
from datetime import datetime, timedelta
from database import async_session_maker
from crud import get_user_by_telegram_id

async with async_session_maker() as session:
    user = await get_user_by_telegram_id(session, 782769400)
    user.subscription_expires_at = datetime.utcnow() + timedelta(days=30)
    await session.commit()
    print(f"‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ {user.subscription_expires_at}")
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏
```python
from utils import get_subscription_status

status = await get_subscription_status(user)
print(f"–ü–æ–¥–ø–∏—Å–∫–∞: {status['has_subscription']}")
print(f"–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: {status['days_left']}")
```

### –û—á–∏—Å—Ç–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
```python
from redis_client import redis_client
from datetime import datetime

today = datetime.utcnow().date().isoformat()
key = f"msg_limit:782769400:{today}"
await redis_client.redis.delete(key)
print("‚úÖ –°—á—ë—Ç—á–∏–∫ —Å–±—Ä–æ—à–µ–Ω")
```

## üìù –õ–æ–≥–∏

### –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
```
INFO - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 782769400 –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å
```

### –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞
```
INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 782769400 –¥–æ—Å—Ç–∏–≥ –ª–∏–º–∏—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
```

### –û—Ç–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø–æ–¥–ø–∏—Å–∫–∏
```
INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 782769400 –æ—Ç–∫—Ä—ã–ª –º–µ–Ω—é –ø–æ–¥–ø–∏—Å–∫–∏
```

### –í—ã–±–æ—Ä —Ç–∞—Ä–∏—Ñ–∞
```
INFO - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 782769400 –≤—ã–±—Ä–∞–ª —Ç–∞—Ä–∏—Ñ 1m
```

---

## üéâ –ò—Ç–æ–≥–æ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏:
- ‚úÖ –õ–∏–º–∏—Ç—ã –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
- ‚úÖ UI –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ –ì–∏–±–∫–∞—è —Ç–∞—Ä–∏—Ñ–Ω–∞—è —Å–µ—Ç–∫–∞
- ‚öôÔ∏è –ó–∞–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (–ÆKassa/Stripe/Stars)
