# üîß –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –ø–ª–∞—Ç–µ–∂–µ–π

## üö® –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
**–ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `update()` –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤:** `webhook_server.py` ‚Üí —Ñ—É–Ω–∫—Ü–∏—è `activate_subscription()`

**–ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ:**
```python
# ‚ùå –ë–´–õ–û (–º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–µ–∫–æ—Ç–æ—Ä—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–µ—Å—Å–∏–∏):
stmt = (
    update(User)
    .where(User.telegram_id == telegram_id)
    .values(subscription_expires_at=expires_at)
)
await session.execute(stmt)
await session.commit()

# ‚úÖ –°–¢–ê–õ–û (–Ω–∞–¥—ë–∂–Ω—ã–π —Å–ø–æ—Å–æ–±):
user.subscription_expires_at = expires_at
session.add(user)
await session.commit()
await session.refresh(user)
```

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å `exc_info=True`
- –Ø–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```bash
python test_webhook_locally.py <telegram_id> check
```

**–ü—Ä–∏–º–µ—Ä:**
```bash
python test_webhook_locally.py 123456789 check
```

### 2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é
```bash
python test_webhook_locally.py <telegram_id> activate [–¥–Ω–µ–π]
```

**–ü—Ä–∏–º–µ—Ä—ã:**
```bash
# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 30 –¥–Ω–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
python test_webhook_locally.py 123456789 activate

# –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ 60 –¥–Ω–µ–π
python test_webhook_locally.py 123456789 activate 60
```

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã webhook

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ webhook —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
Get-Process -Name "python" | Where-Object { $_.CommandLine -like "*webhook_server.py*" }

# –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞
Test-NetConnection -ComputerName localhost -Port 8000
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å webhook endpoint
```bash
curl http://localhost:8000/health
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:**
```json
{"status":"healthy","timestamp":"2025-11-21T..."}
```

### 3. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å webhook –ª–æ–∫–∞–ª—å–Ω–æ
```bash
curl -X POST http://localhost:8000/webhook/test `
  -H "Content-Type: application/json" `
  -d '{"telegram_id": 123456789, "days": 30}'
```

---

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

### –õ–æ–≥–∏ webhook —Å–µ—Ä–≤–µ—Ä–∞
Webhook —Å–µ—Ä–≤–µ—Ä –ø–∏—à–µ—Ç –ª–æ–≥–∏ –≤ stdout/stderr. –ï—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω –∫–∞–∫ —Å–µ—Ä–≤–∏—Å:

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å–µ—Ä–≤–∏—Å–∞ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω systemd –Ω–∞ Linux)
sudo journalctl -u ai-gf-webhook.service -f

# –ò–ª–∏ –µ—Å–ª–∏ –ª–æ–≥–∏ –∏–¥—É—Ç –≤ —Ñ–∞–π–ª
tail -f /var/log/ai-gf-webhook.log
```

### –ß—Ç–æ –∏—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö:
- `üì® –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: payment.succeeded` ‚Äî –ø–æ–ª—É—á–µ–Ω webhook
- `‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞/–ø—Ä–æ–¥–ª–µ–Ω–∞` ‚Äî –ø–æ–¥–ø–∏—Å–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- `‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ... –Ω–µ –Ω–∞–π–¥–µ–Ω` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –ë–î
- `‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê` ‚Äî –æ—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î

---

## ‚öôÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ .env:
```env
# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
DATABASE_URL=postgresql+asyncpg://user:password@localhost/ai_gf

# –ÆKassa
PAYMENT_SHOP_ID=–≤–∞—à_shop_id
PAYMENT_SECRET_KEY=–≤–∞—à_secret_key
WEBHOOK_URL=https://–≤–∞—à-–¥–æ–º–µ–Ω.ru/webhook/yookassa
YOOKASSA_WEBHOOK_SECRET=–≤–∞—à_webhook_secret

# Telegram Bot
BOT_TOKEN=–≤–∞—à_bot_token
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:
```bash
Get-Content .env | Select-String -Pattern "(DATABASE_URL|PAYMENT|WEBHOOK)"
```

---

## üêõ –¢–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –ø–æ–ª—É—á–µ–Ω, –Ω–æ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î (–Ω–µ –∑–∞–ø—É—Å–∫–∞–ª –±–æ—Ç–∞)
2. –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `telegram_id` –≤ metadata –ø–ª–∞—Ç–µ–∂–∞

**–†–µ—à–µ–Ω–∏–µ:**
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å—Ç–∏–ª –±–æ—Ç–∞ (`/start`)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ webhook —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ metadata –ø–ª–∞—Ç–µ–∂–∞ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `telegram_id`

### –ü—Ä–æ–±–ª–µ–º–∞: Webhook –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç –ÆKassa

**–ü—Ä–∏—á–∏–Ω—ã:**
1. Webhook URL –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL webhook
3. –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (firewall, nginx)

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –≤ –ÆKassa
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ URL –¥–æ—Å—Ç—É–ø–µ–Ω: `curl https://–≤–∞—à-–¥–æ–º–µ–Ω.ru/webhook/yookassa`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ nginx/firewall –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook

**–ü—Ä–∏—á–∏–Ω—ã:**
1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `YOOKASSA_WEBHOOK_SECRET`
2. Webhook secret –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ÆKassa

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü–æ–ª—É—á–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π webhook secret –∏–∑ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –ÆKassa
2. –û–±–Ω–æ–≤–∏—Ç–µ `.env` —Ñ–∞–π–ª
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ webhook —Å–µ—Ä–≤–µ—Ä

**–í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!):**
```env
YOOKASSA_DISABLE_SIGNATURE_CHECK=true
```

---

## üìù –ß–µ–∫–ª–∏—Å—Ç –ø–µ—Ä–µ–¥ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–æ–º

- [ ] –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã
- [ ] Webhook URL –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
- [ ] Webhook secret –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ÆKassa
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ –≤–∫–ª—é—á–µ–Ω–∞ (`YOOKASSA_DISABLE_SIGNATURE_CHECK=false`)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–µ—Ä–≤–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–±–æ–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (health check)

---

## üÜò –≠–∫—Å—Ç—Ä–µ–Ω–Ω–∞—è –ø–æ–º–æ—â—å

–ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç:

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
   ```bash
   python test_webhook_locally.py <telegram_id> check
   ```

2. **–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤—Ä—É—á–Ω—É—é:**
   ```bash
   python test_webhook_locally.py <telegram_id> activate 30
   ```

3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook:**
   ```bash
   tail -f /path/to/webhook.log
   ```

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î:**
   ```bash
   python test_db_connection.py
   ```

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

- GitHub Issues: https://github.com/Levin-Alexey/ai_gf/issues
- Telegram Support: @AIGFSupport
