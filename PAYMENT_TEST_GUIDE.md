# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã (10‚ÇΩ –∑–∞ 1 –º–µ—Å—è—Ü)

## ‚úÖ –ß—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤–æ:

1. ‚úÖ **–¢–∞—Ä–∏—Ñ**: 10‚ÇΩ –∑–∞ 30 –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
2. ‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –ü–æ–ª–µ `subscription_expires_at` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è
3. ‚úÖ **Webhook**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
4. ‚úÖ **–õ–∏–º–∏—Ç—ã**: 5 —Å–æ–æ–±—â–µ–Ω–∏–π/–¥–µ–Ω—å –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö, –±–µ–∑–ª–∏–º–∏—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤

---

## üöÄ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

```bash
cd /root/ai_gf
source venv/bin/activate
python test_payment_flow.py –í–ê–®_TELEGRAM_ID
```

–ü—Ä–∏–º–µ—Ä:
```bash
python test_payment_flow.py 782769400
```

–°–∫—Ä–∏–ø—Ç –ø–æ–∫–∞–∂–µ—Ç:
- ‚úÖ –°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
- ‚úÖ –¢–µ–∫—É—â—É—é –ø–æ–¥–ø–∏—Å–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
- ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–ª–∞—Ç—ë–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
- ‚úÖ –°—Ç–∞—Ç—É—Å webhook —Å–µ—Ä–≤–µ—Ä–∞

---

### –®–∞–≥ 2: –û—Ç–∫—Ä—ã—Ç—å –ª–æ–≥–∏ webhook (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)

```bash
sudo journalctl -u ai-gf-webhook -f
```

–û—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã–º ‚Äî —É–≤–∏–¥–∏—Ç–µ –≤—Å–µ —Å–æ–±—ã—Ç–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

---

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π

–í Telegram –±–æ—Ç–µ:

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ **6 —Å–æ–æ–±—â–µ–Ω–∏–π** –ø–æ–¥—Ä—è–¥
2. –ù–∞ **6-–º —Å–æ–æ–±—â–µ–Ω–∏–∏** –ø–æ—è–≤–∏—Ç—Å—è:
   ```
   ‚õî –í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ (5 —Å–æ–æ–±—â–µ–Ω–∏–π)
   
   –û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –±–µ–∑–ª–∏–º–∏—Ç–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è!
   
   [üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É]
   ```

---

### –®–∞–≥ 4: –û—Ñ–æ—Ä–º–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É

1. –ù–∞–∂–º–∏—Ç–µ **"üí≥ –û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"**
2. –ü–æ—è–≤–∏—Ç—Å—è:
   ```
   üíé –¢–µ—Å—Ç–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
   
   –° –ø–æ–¥–ø–∏—Å–∫–æ–π –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:
   ‚Ä¢ ‚ôæÔ∏è –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   ‚Ä¢ üé≠ –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º
   ‚Ä¢ ‚ö° –ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã
   ‚Ä¢ üí¨ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞
   
   üß™ –¢–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥ ‚Äî –≤—Å–µ–≥–æ 10‚ÇΩ!
   
   [üìÖ 1 –º–µ—Å—è—Ü ‚Äî 10‚ÇΩ (–¢–ï–°–¢)]
   [‚ùå –û—Ç–º–µ–Ω–∞]
   ```

3. –ù–∞–∂–º–∏—Ç–µ **"üìÖ 1 –º–µ—Å—è—Ü ‚Äî 10‚ÇΩ (–¢–ï–°–¢)"**

---

### –®–∞–≥ 5: –û–ø–ª–∞—Ç–∏—Ç—å

1. –ü–æ—è–≤–∏—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ:
   ```
   üí≥ –û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏
   
   –¢–∞—Ä–∏—Ñ: 1 –º–µ—Å—è—Ü (–¢–ï–°–¢)
   –°—É–º–º–∞: 10‚ÇΩ
   
   –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –æ–ø–ª–∞—Ç–µ.
   –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏! ‚ú®
   
   [üí≥ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ]
   ```

2. –ù–∞–∂–º–∏—Ç–µ **"üí≥ –ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ"**

3. –û—Ç–∫—Ä–æ–µ—Ç—Å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ÆKassa

4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ **—Ç–µ—Å—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É**:
   - **–ù–æ–º–µ—Ä**: `5555 5555 5555 4444`
   - **–°—Ä–æ–∫**: `12/24` (–ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞)
   - **CVC**: `123`
   - **–ò–º—è**: –ª—é–±–æ–µ

5. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É

---

### –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏—é

**–í –ª–æ–≥–∞—Ö webhook** (—Ç–µ—Ä–º–∏–Ω–∞–ª —Å `journalctl`) —É–≤–∏–¥–∏—Ç–µ:

```
INFO - üì® –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: payment.succeeded
INFO - ‚úîÔ∏è –ü–æ–¥–ø–∏—Å—å webhook –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
INFO - üí∞ –ü–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–µ–Ω: <payment_id>
INFO - üë§ Telegram ID: 782769400
INFO - üìÖ –î–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏: 30
INFO - ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è 782769400 –Ω–∞ 30 –¥–Ω–µ–π –¥–æ 2025-11-21 ...
```

---

### –®–∞–≥ 7: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```bash
python test_payment_flow.py –í–ê–®_TELEGRAM_ID
```

–î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å:
```
2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏...
   ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
   üìÖ –ò—Å—Ç–µ–∫–∞–µ—Ç: 2025-11-21 19:45:30 UTC
   ‚è≥ –û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: 30
```

---

### –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω—è—Ç–∏–µ –ª–∏–º–∏—Ç–∞

–í –±–æ—Ç–µ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ **–ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π** ‚Äî –ª–∏–º–∏—Ç –±–æ–ª—å—à–µ –Ω–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç! üéâ

---

## üîç –ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:

–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤ —Ç–∞–±–ª–∏—Ü–µ `users` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:

```sql
UPDATE users 
SET subscription_expires_at = '2025-11-21 19:45:30+00'
WHERE telegram_id = 782769400;
```

**–ü–æ–ª—è:**
- `telegram_id`: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- `subscription_expires_at`: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ (UTC —Å timezone)

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä—É—á–Ω—É—é:**

```bash
cd /root/ai_gf
source venv/bin/activate
python
```

```python
import asyncio
from database import async_session_maker
from sqlalchemy import select
from models import User

async def check():
    async with async_session_maker() as session:
        result = await session.execute(
            select(User).where(User.telegram_id == 782769400)
        )
        user = result.scalar_one_or_none()
        print(f"–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ: {user.subscription_expires_at}")

asyncio.run(check())
```

---

## üìä –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:

### –ë–µ–∑ –ø–æ–¥–ø–∏—Å–∫–∏ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ):
1. –ë–æ—Ç —Å—á–∏—Ç–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Redis: `msg_limit:{telegram_id}:{YYYY-MM-DD}`
2. –õ–∏–º–∏—Ç: **5 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–µ–Ω—å**
3. –ù–∞ 6-–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Üí –∫–Ω–æ–ø–∫–∞ "–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É"

### –° –ø–æ–¥–ø–∏—Å–∫–æ–π:
1. –ü—Ä–æ–≤–µ—Ä–∫–∞: `user.subscription_expires_at > now()`
2. –ï—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ ‚Üí **–±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**
3. –°—á—ë—Ç—á–∏–∫ Redis –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### Webhook –æ—Ç –ÆKassa:
1. –ü–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ `payment.succeeded`
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç HMAC SHA-256 –ø–æ–¥–ø–∏—Å—å
3. –ß–∏—Ç–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: `telegram_id`, `days`
4. –û–±–Ω–æ–≤–ª—è–µ—Ç `subscription_expires_at = now() + days`
5. –ö–æ–º–º–∏—Ç–∏—Ç –≤ –ë–î

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:

- [x] –¢–∞—Ä–∏—Ñ –æ–±–Ω–æ–≤–ª—ë–Ω: 10‚ÇΩ –∑–∞ 30 –¥–Ω–µ–π
- [x] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–ª–µ–º `subscription_expires_at`
- [x] Webhook —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: `sudo systemctl status ai-gf-webhook`
- [x] Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω: `https://pay.aigirlfriendbot.ru/health`
- [x] Webhook URL –≤ –ÆKassa: `https://pay.aigirlfriendbot.ru/webhook/yookassa`
- [x] –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç: `python test_payment_flow.py <telegram_id>`

---

## üêõ Troubleshooting:

### –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–ª–∞—Å—å

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ webhook
sudo journalctl -u ai-gf-webhook -n 100

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ webhook –ø–æ–ª—É—á–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "üì® –ü–æ–ª—É—á–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ: payment.succeeded"

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å—å
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "‚úîÔ∏è –ü–æ–¥–ø–∏—Å—å webhook –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞"

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–∫—Ç–∏–≤–∞—Ü–∏—é
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: "‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è ..."
```

### Webhook –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```bash
# 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ÆKassa
# https://yookassa.ru/my/shop-settings ‚Üí HTTP-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

# 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ webhook –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ
curl https://pay.aigirlfriendbot.ru/health

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ nginx —Ä–∞–±–æ—Ç–∞–µ—Ç
sudo systemctl status nginx

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ nginx
sudo tail -f /var/log/nginx/pay.aigirlfriendbot.ru.access.log
```

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é!** üöÄüí∞
